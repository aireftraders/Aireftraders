<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Ads to Continue</title>
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <style>
        :root {
            --primary: #6C5CE7;
            --primary-dark: #5649c0;
            --success: #00B894;
            --danger: #e74c3c;
            --light: #f8f9fa;
            --dark: #343a40;
            --border-radius: 12px;
            --box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            --transition: all 0.3s ease;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .ad-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 2.5rem;
            width: 90%;
            max-width: 900px;
            margin: 2rem auto;
            box-shadow: var(--box-shadow);
            text-align: center;
        }
        
        .ad-header {
            margin-bottom: 1.5rem;
        }
        
        .ad-header h2 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0 0 0.5rem;
            color: var(--dark);
            background: linear-gradient(to right, var(--primary), #a55eea);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .ad-header p {
            font-size: 1.1rem;
            color: #6c757d;
            margin: 0;
        }
        
        #adFrameContainer {
            width: 100%;
            min-height: 300px;
            margin: 2rem auto;
            border-radius: var(--border-radius);
            background: var(--light);
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(0,0,0,0.08);
        }
        
        #adFrame {
            width: 100%;
            height: 100%;
            min-height: 300px;
            border: none;
        }
        
        .progress-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin: 2rem 0;
            gap: 0.5rem;
        }
        
        .progress-step {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            transition: var(--transition);
            position: relative;
        }
        
        .progress-step.active {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.2);
        }
        
        .progress-step.completed {
            background: var(--success);
            color: white;
        }
        
        .progress-step.completed::after {
            content: '‚úì';
            position: absolute;
        }
        
        #timerDisplay {
            margin: 1.5rem 0;
            font-weight: 600;
            font-size: 1.2rem;
            color: #495057;
        }
        
        #timerCount {
            font-weight: 700;
            color: var(--primary);
        }
        
        .watch-ad-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }
        
        .watch-ad-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
        }
        
        .watch-ad-btn:active {
            transform: translateY(0);
        }
        
        .ad-status {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin: 1rem 0;
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .access-denied {
            margin: 2rem 0;
            padding: 1.5rem;
            background: rgba(231, 76, 60, 0.1);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--danger);
        }
        
        .access-denied h3 {
            color: var(--danger);
            margin-top: 0;
            font-size: 1.3rem;
        }
        
        .time-remaining {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .time-remaining span {
            color: var(--primary);
            font-weight: 700;
        }
        
        /* Game Console Button Styles */
        .game-console-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6C5CE7, #00CEFF);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            display: none;
        }

        .game-console-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
        }

        .game-console-btn::before {
            content: "";
            position: absolute;
            width: 30px;
            height: 30px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M21 7H3c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2zm0 8H3V9h18v6z"/><circle cx="8" cy="12" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="16" cy="12" r="1.5"/></svg>') no-repeat center center;
            background-size: contain;
        }

        .game-console-text {
            position: fixed;
            bottom: 90px;
            right: 20px;
            color: var(--primary);
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            background: white;
            padding: 5px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }

        /* Theme Toggle Styles */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .theme-toggle-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .theme-toggle-btn:hover {
            background: var(--primary-dark);
        }

        /* Language Selector Styles */
        .language-selector {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: var(--box-shadow);
        }

        #languageDropdown {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        @media (max-width: 768px) {
            .ad-container {
                padding: 1.5rem;
                width: 95%;
            }
            
            .ad-header h2 {
                font-size: 1.5rem;
            }
            
            .ad-header p {
                font-size: 1rem;
            }
            
            #adFrameContainer, #adFrame {
                min-height: 250px;
            }
            
            .progress-step {
                width: 2rem;
                height: 2rem;
                font-size: 0.8rem;
            }
            
            .game-console-text {
                bottom: 85px;
                right: 15px;
                font-size: 0.8rem;
            }

            .theme-toggle, .language-selector {
                position: static;
                margin: 10px auto;
                width: fit-content;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <div class="theme-toggle">
        <button class="theme-toggle-btn" id="themeToggle">
            <span class="theme-icon" id="themeIcon">üåô</span>
            <span id="themeText">Dark Mode</span>
        </button>
    </div>

    <!-- Language Selector -->
    <div class="language-selector">
        <label for="languageDropdown">üåê Select Language:</label>
        <select id="languageDropdown">
            <option value="en">English</option>
            <option value="ha">Hausa</option>
            <option value="yo">Yoruba</option>
            <option value="ig">Igbo</option>
        </select>
    </div>
    
    <!-- Navigation bar -->
    <nav style="width: 100%; background: var(--primary); padding: 1rem; text-align: center; box-shadow: var(--box-shadow);">
        <a href="index.html" style="color: white; text-decoration: none; font-size: 1.2rem; font-weight: 600;">Dashboard</a>
    </nav>
    
    <div class="ad-container" id="mainContainer">
        <div class="ad-header">
            <h2>Complete Ads to Continue</h2>
            <p id="adPurpose">Watch ads to unlock access</p>
        </div>
        
        <div class="ad-status">
            <span>Progress: <span id="completedCount">0</span>/20</span>
            <span>Estimated time: <span id="estimatedTime">5 minutes</span></span>
        </div>
        
        <div class="progress-container" id="progressSteps"></div>
        
        <div id="adFrameContainer">
            <!-- Ad will be loaded here -->
        </div>
        
        <div id="timerDisplay">Ad completes in <span id="timerCount">15</span> seconds</div>
        
        <button class="watch-ad-btn" id="watchAdBtn">Watch Ad</button>
    </div>

    <div class="game-console-btn" id="gameConsoleBtn"></div>
    <div class="game-console-text" id="gameConsoleText">Play Games</div>

    <script>
        // Initialize Dexie database
        const db = new Dexie("AI_REF_TRADERS_DB");
        
        // Define database schema (must match index.html)
        db.version(1).stores({
            users: '++id, telegramId, balance, referrals, adsWatched, totalAdsWatched, verified, tradingActive, tradingCapital, dailyProfit, totalProfit, withdrawableProfit, bankDetails, paymentCircle, gameEarnings, lastAdWatchTime, streak, announcements',
            announcements: '++id, title, content, time, unread',
            supportTickets: '++id, userId, subject, message, status, createdAt',
            adminCredentials: '++id, username, password',
            transactions: '++id, userId, type, amount, status, timestamp'
        });

        // Configuration
        const totalAds = 20;
        const minAdDuration = 15000; // 15 seconds per ad
        const accessCooldown = 60 * 60 * 1000; // 60 minutes in milliseconds
        let currentAdCount = 0;
        let timer = null;
        let adStartTime = 0;
        let canCountAd = false;
        let accessDenied = false;
        let cooldownInterval = null;
        let redirectTo = 'game.html'; // Default to game.html
        let userData = null;
        let timerInterval = null;
        let timerStartTime = 0;
        const gameDuration = 55 * 60 * 1000; // 55 minutes in milliseconds

        // Theme management
        function applyTheme(isDark) {
            const root = document.documentElement;
            if (isDark) {
                root.style.setProperty('--light', '#343a40');
                root.style.setProperty('--dark', '#f8f9fa');
                document.body.style.background = 'linear-gradient(135deg, #2d3436 0%, #1e272e 100%)';
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
                document.getElementById('themeText').textContent = 'Light Mode';
            } else {
                root.style.setProperty('--light', '#f8f9fa');
                root.style.setProperty('--dark', '#343a40');
                document.body.style.background = 'linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%)';
                document.getElementById('themeIcon').textContent = 'üåô';
                document.getElementById('themeText').textContent = 'Dark Mode';
            }
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
        }

        // Check for saved theme preference
        if (localStorage.getItem('darkMode') === 'enabled') {
            applyTheme(true);
        }

        // Toggle theme
        document.getElementById('themeToggle').addEventListener('click', () => {
            const isDark = localStorage.getItem('darkMode') !== 'enabled';
            applyTheme(isDark);
        });

        // Language management
        document.getElementById('languageDropdown').addEventListener('change', (e) => {
            localStorage.setItem('preferredLanguage', e.target.value);
            // Here you would typically reload translations
            // For now we'll just store the preference
        });

        // Set initial language
        const savedLanguage = localStorage.getItem('preferredLanguage') || 'en';
        document.getElementById('languageDropdown').value = savedLanguage;

        // Load user data from IndexedDB
        async function loadUserData() {
            try {
                // For demo purposes, we'll use a default user if not in Telegram
                const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'demo-user';
                
                // Check if user exists in database
                let user = await db.users.where('telegramId').equals(userId).first();
                
                if (!user) {
                    // Create new user with default values
                    user = {
                        telegramId: userId,
                        balance: 5000,
                        referrals: 0,
                        adsWatched: 0,
                        totalAdsWatched: 0,
                        tradingActive: false,
                        verified: false,
                        tradingCapital: 0,
                        dailyProfit: 0,
                        totalProfit: 0,
                        withdrawableProfit: 0,
                        bankDetails: null,
                        paymentCircle: { current: 0, total: 1000 },
                        gameEarnings: 0,
                        lastAdWatchTime: null,
                        streak: {
                            count: 0,
                            lastLogin: null,
                            bonus: 0
                        },
                        announcements: {
                            read: [2],
                            unread: [1]
                        },
                        showGamesButton: false,
                        gameTimerStart: 0
                    };
                    
                    // Add new user to database
                    await db.users.add(user);
                }
                
                // Update user data
                userData = user;
                currentAdCount = userData.adsWatched || 0;
                
                // Check if we should show the game console button
                checkGameConsoleButton();
                
                return userData;
            } catch (error) {
                console.error('Error loading user data:', error);
                return null;
            }
        }

        // Save user data to IndexedDB
        async function saveUserData() {
            try {
                const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'demo-user';
                await db.users.where('telegramId').equals(userId).modify(userData);
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }

        // Check if game console button should be shown
        function checkGameConsoleButton() {
            if (!userData) return;
            
            const now = Date.now();
            const lastWatchTime = userData.lastAdWatchTime || 0;
            
            // Show button if user has completed ads and is within cooldown period
            if (userData.adsWatched >= totalAds && (now - lastWatchTime) < accessCooldown) {
                document.getElementById('gameConsoleBtn').style.display = 'flex';
                document.getElementById('gameConsoleText').style.display = 'block';
                userData.showGamesButton = true;
            } else {
                document.getElementById('gameConsoleBtn').style.display = 'none';
                document.getElementById('gameConsoleText').style.display = 'none';
                userData.showGamesButton = false;
            }
            
            saveUserData();
        }

        // Check access status
        function checkAccessStatus() {
            if (!userData) return false;
            
            const now = Date.now();
            const lastWatchTime = userData.lastAdWatchTime || 0;
            
            // If user has completed ads and it's been less than cooldown
            if (userData.adsWatched >= totalAds && (now - lastWatchTime) < accessCooldown) {
                accessDenied = true;
                showAccessDenied(lastWatchTime + accessCooldown, redirectTo);
                
                // Show games button during cooldown
                userData.showGamesButton = true;
                saveUserData();
                checkGameConsoleButton();
                return true;
            }
            
            // Reset if cooldown is over
            if (userData.adsWatched >= totalAds && (now - lastWatchTime) >= accessCooldown) {
                userData.adsWatched = 0;
                userData.lastAdWatchTime = 0;
                userData.showGamesButton = false;
                saveUserData();
                checkGameConsoleButton();
            }
            
            return false;
        }

        // Show access denied message
        function showAccessDenied(expiryTime, redirectUrl) {
            const mainContainer = document.getElementById('mainContainer');
            mainContainer.innerHTML = `
                <div class="ad-header">
                    <h2>Ads Limit Reached</h2>
                    <p>You've completed your daily ads</p>
                </div>
                
                <div class="access-denied">
                    <h3>Access Temporarily Unavailable</h3>
                    <p>You've watched 20 ads. Please try again in 60 minutes.</p>
                    <div class="time-remaining">Time remaining: <span id="cooldownTimer"></span></div>
                </div>
                
                <button class="watch-ad-btn" id="returnBtn">Return to Previous Page</button>
            `;
            
            updateCooldownTimer(expiryTime);
            cooldownInterval = setInterval(() => updateCooldownTimer(expiryTime), 1000);
            
            document.getElementById('returnBtn').addEventListener('click', () => {
                window.location.href = document.referrer || 'index.html';
            });
        }

        function updateCooldownTimer(expiryTime) {
            const remaining = expiryTime - Date.now();
            if (remaining <= 0) {
                clearInterval(cooldownInterval);
                
                // Hide games button when cooldown ends
                userData.showGamesButton = false;
                saveUserData();
                checkGameConsoleButton();
                
                window.location.reload();
                return;
            }
            
            const minutes = Math.floor(remaining / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
            
            document.getElementById('cooldownTimer').textContent = 
                `${minutes}m ${seconds}s`;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Load user data
            await loadUserData();
            
            // Check if we should show games button from previous state
            checkGameConsoleButton();
            
            // Setup game console button
            document.getElementById('gameConsoleBtn').addEventListener('click', () => {
                window.location.href = 'game.html?fromConsole=true';
            });
            
            // Check access status
            if (checkAccessStatus()) return;
            
            // Setup page
            setupPage();
        });

        function setupPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const source = urlParams.get('source');
            
            if (source === 'games' || source === 'trading') {
                redirectTo = source + '.html';
                localStorage.setItem('postAdRedirect', redirectTo);
            } else {
                const storedRedirect = localStorage.getItem('postAdRedirect');
                if (storedRedirect) {
                    redirectTo = storedRedirect;
                } else if (document.referrer && document.referrer.includes('games.html')) {
                    redirectTo = 'games.html';
                } else if (document.referrer && document.referrer.includes('trading.html')) {
                    redirectTo = 'trading.html';
                }
                localStorage.setItem('postAdRedirect', redirectTo);
            }

            currentAdCount = Math.min(userData?.adsWatched || 0, totalAds);
            
            if (currentAdCount >= totalAds) {
                grantAccessAndRedirect();
                return;
            }
            
            updateProgressDisplay();
            loadAd();
            
            document.getElementById('watchAdBtn').addEventListener('click', handleAdWatch);
        }

        function updateProgressDisplay() {
            const remaining = Math.max(0, totalAds - currentAdCount);
            const estimatedMinutes = Math.ceil((remaining * minAdDuration) / 60000);
            
            document.getElementById('adPurpose').textContent = 
                remaining > 0 ? `Watch ${remaining} more ads to continue` : 'All ads completed!';
            document.getElementById('completedCount').textContent = currentAdCount;
            document.getElementById('estimatedTime').textContent = 
                estimatedMinutes > 1 ? `${estimatedMinutes} minutes` : 'less than a minute';
            
            const container = document.getElementById('progressSteps');
            container.innerHTML = '';
            
            for (let i = 0; i < totalAds; i++) {
                const step = document.createElement('div');
                step.className = 'progress-step';
                step.textContent = i + 1;
                if (i < currentAdCount) {
                    step.classList.add('completed');
                    step.textContent = '';
                }
                if (i === currentAdCount && currentAdCount < totalAds) {
                    step.classList.add('active');
                }
                container.appendChild(step);
            }
        }

        function loadAd() {
            canCountAd = false;
            adStartTime = Date.now();
            
            const adContainer = document.getElementById('adFrameContainer');
            adContainer.innerHTML = '';
            
            // Load ad scripts
            const adScript1 = document.createElement('script');
            adScript1.type = 'text/javascript';
            adScript1.innerHTML = `
                atOptions = {
                    'key' : '8a1d6d42d6addf614a0b20c144270316',
                    'format' : 'iframe',
                    'height' : 250,
                    'width' : 300,
                    'params' : {}
                };
            `;

            const adScript2 = document.createElement('script');
            adScript2.type = 'text/javascript';
            adScript2.src = '//innumerablemakeupreligious.com/8a1d6d42d6addf614a0b20c144270316/invoke.js';

            adContainer.appendChild(adScript1);
            adContainer.appendChild(adScript2);
            
            startTimer();
        }

        function startTimer() {
            let seconds = 15;
            updateTimerDisplay(seconds);
            
            clearInterval(timer);
            timer = setInterval(() => {
                seconds--;
                updateTimerDisplay(seconds);
                
                if (seconds <= 0) {
                    clearInterval(timer);
                    canCountAd = true;
                    document.getElementById('watchAdBtn').textContent = "Continue";
                    document.getElementById('watchAdBtn').style.backgroundColor = 'var(--success)';
                }
            }, 1000);
        }

        function updateTimerDisplay(seconds) {
            document.getElementById('timerCount').textContent = seconds;
            document.getElementById('timerCount').style.color = seconds <= 5 ? 'var(--danger)' : 'var(--primary)';
        }

        async function handleAdWatch() {
            if (!canCountAd) {
                const elapsed = Date.now() - adStartTime;
                const remaining = Math.ceil((minAdDuration - elapsed) / 1000);
                alert(`Please watch the ad for ${remaining} more seconds before continuing.`);
                return;
            }

            currentAdCount++;
            
            // Update user data
            userData.adsWatched = currentAdCount;
            userData.totalAdsWatched = (userData.totalAdsWatched || 0) + 1;
            userData.lastAdWatchTime = Date.now();
            await saveUserData();
            
            // Notify parent/opener window (index.html) if exists
            const targetWindow = window.opener || window.parent;
            if (targetWindow && targetWindow !== window) {
                targetWindow.postMessage({
                    type: 'adCountUpdate',
                    adsWatched: currentAdCount,
                    totalAdsWatched: userData.totalAdsWatched,
                    lastAdWatchTime: userData.lastAdWatchTime
                }, '*');
            }

            if (currentAdCount >= totalAds) {
                // Show game console button when all ads are completed
                userData.showGamesButton = true;
                await saveUserData();
                checkGameConsoleButton();
                
                grantAccessAndRedirect();
                return;
            }

            updateProgressDisplay();
            document.getElementById('watchAdBtn').textContent = "Watch Ad";
            document.getElementById('watchAdBtn').style.backgroundColor = 'var(--primary)';
            loadAd();
        }

        function grantAccessAndRedirect() {
            const redirectUrl = localStorage.getItem('postAdRedirect') || 'game.html';
            const finalRedirectUrl = redirectUrl.includes('?') 
                ? `${redirectUrl}&fromAds=true` 
                : `${redirectUrl}?fromAds=true`;
            window.location.href = finalRedirectUrl;
        }
    </script>
</body>
</html>
