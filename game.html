<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Previous head content remains the same -->
</head>
<body>
    <!-- Previous body content remains the same until the script section -->

    <script>
        // Initialize Dexie database with same structure as index.html
        const db = new Dexie("AI_REF_TRADERS_DB");
        db.version(1).stores({
            users: '++id, telegramId, balance, referrals, adsWatched, lastAdWatchTime, gameState, gameSessionStart',
            announcements: '++id, title, content, time, unread',
            supportTickets: '++id, userId, subject, message, status, createdAt',
            adminCredentials: '++id, username, password',
            transactions: '++id, userId, type, amount, status, timestamp'
        });

        // ========================
        // GAME STATE MANAGEMENT
        // ========================
        
        const gameState = {
            balance: 0,
            memory: { attempts: 10, wins: 0, earnings: 0 },
            dice: { attempts: 10, wins: 0, earnings: 0 },
            snake: { attempts: 10, score: 0, earnings: 0 },
            trivia: { attempts: 10, correct: 0, earnings: 0, usedQuestions: [] },
            wheel: { attempts: 10, wins: 0, earnings: 0 },
            gameSessionStart: 0, // Timestamp when session started
            sessionActive: false // Whether the current session is active
        };

        // Initialize game state based on URL parameters
        async function initializeGameState() {
            const urlParams = new URLSearchParams(window.location.search);
            const fromAds = urlParams.has('fromAds');
            const fromConsole = urlParams.has('fromConsole');
            
            try {
                const userId = 'demo-user'; // In a real app, get from Telegram or auth
                const savedData = await db.users.where('telegramId').equals(userId).first();
                
                if (!savedData) {
                    // If no user data found, redirect to ads page
                    showAccessDenied("No user data found. Please watch ads first.");
                    return false;
                }
                
                // Check if user has watched 20 ads
                if (savedData.adsWatched < 20) {
                    showAccessDenied(`You've only watched ${savedData.adsWatched}/20 ads. Please complete watching ads.`);
                    return false;
                }
                
                // Check if coming from valid source
                if (!fromAds && !fromConsole) {
                    showAccessDenied("Invalid access. Please use the game console button from ads page.");
                    return false;
                }
                
                // Check if copied URL with fromConsole=true
                if (fromConsole && !document.referrer.includes('ads.html')) {
                    showAccessDenied("Invalid access detected. Please use the game console button from ads page.");
                    return false;
                }
                
                // Get balance from storage
                gameState.balance = savedData?.balance || 0;
                
                // Check if we have an active session
                const now = Date.now();
                const sessionExpired = !savedData.gameSessionStart || 
                                      (now - savedData.gameSessionStart) >= 55 * 60 * 1000;
                
                // Reset attempts only if coming from ads.html after watching 20 ads and session expired
                if (fromAds && sessionExpired) {
                    // Reset all game attempts
                    gameState.memory.attempts = 10;
                    gameState.dice.attempts = 10;
                    gameState.snake.attempts = 10;
                    gameState.trivia.attempts = 10;
                    gameState.wheel.attempts = 10;
                    
                    // Reset game stats
                    gameState.memory.wins = 0;
                    gameState.memory.earnings = 0;
                    gameState.dice.wins = 0;
                    gameState.dice.earnings = 0;
                    gameState.snake.score = 0;
                    gameState.snake.earnings = 0;
                    gameState.trivia.correct = 0;
                    gameState.trivia.earnings = 0;
                    gameState.trivia.usedQuestions = [];
                    gameState.wheel.wins = 0;
                    gameState.wheel.earnings = 0;
                    
                    // Start new session
                    gameState.gameSessionStart = now;
                    gameState.sessionActive = true;
                    
                    // Save to DB
                    await db.users.where('telegramId').equals(userId).modify({
                        gameState: gameState,
                        gameSessionStart: gameState.gameSessionStart
                    });
                    
                    // Start session timer
                    startSessionTimer();
                } 
                // If session is still active, load saved state
                else if (!sessionExpired && savedData?.gameState) {
                    gameState.memory.attempts = savedData.gameState.memory?.attempts || 10;
                    gameState.dice.attempts = savedData.gameState.dice?.attempts || 10;
                    gameState.snake.attempts = savedData.gameState.snake?.attempts || 10;
                    gameState.trivia.attempts = savedData.gameState.trivia?.attempts || 10;
                    gameState.wheel.attempts = savedData.gameState.wheel?.attempts || 10;
                    
                    // Load other stats
                    gameState.memory.wins = savedData.gameState.memory?.wins || 0;
                    gameState.memory.earnings = savedData.gameState.memory?.earnings || 0;
                    gameState.dice.wins = savedData.gameState.dice?.wins || 0;
                    gameState.dice.earnings = savedData.gameState.dice?.earnings || 0;
                    gameState.snake.score = savedData.gameState.snake?.score || 0;
                    gameState.snake.earnings = savedData.gameState.snake?.earnings || 0;
                    gameState.trivia.correct = savedData.gameState.trivia?.correct || 0;
                    gameState.trivia.earnings = savedData.gameState.trivia?.earnings || 0;
                    gameState.trivia.usedQuestions = savedData.gameState.trivia?.usedQuestions || [];
                    gameState.wheel.wins = savedData.gameState.wheel?.wins || 0;
                    gameState.wheel.earnings = savedData.gameState.wheel?.earnings || 0;
                    
                    gameState.gameSessionStart = savedData.gameSessionStart;
                    gameState.sessionActive = true;
                    
                    // Start session timer if not already running
                    startSessionTimer();
                }
                // If session expired but user tries to access from console
                else if (sessionExpired && fromConsole) {
                    showAccessDenied("Your game session has expired. Please watch ads again.");
                    return false;
                }
                
                // Save initial state
                await saveGameState();
                return true;
            } catch (error) {
                console.error('Error initializing game state:', error);
                showAccessDenied("Error loading game data. Please try again.");
                return false;
            }
        }

        // Start session timer
        function startSessionTimer() {
            const timerDisplay = document.getElementById('timerDisplay');
            const timeRemaining = document.getElementById('timeRemaining');
            
            timerDisplay.style.display = 'block';
            
            const updateTimer = () => {
                const now = Date.now();
                const timeElapsed = now - gameState.gameSessionStart;
                const timeLeft = Math.max(0, 55 * 60 * 1000 - timeElapsed);
                
                const minutes = Math.floor(timeLeft / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                timeRemaining.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Check if session expired
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    gameState.sessionActive = false;
                    showAccessDenied("Your game session has expired. Please watch ads again.");
                }
            };
            
            updateTimer();
            const timerInterval = setInterval(updateTimer, 1000);
        }

        // Save game state to IndexedDB
        async function saveGameState() {
            try {
                const userId = 'demo-user'; // In a real app, get from Telegram or auth
                
                await db.users.put({
                    telegramId: userId,
                    balance: gameState.balance,
                    gameState: {
                        memory: gameState.memory,
                        dice: gameState.dice,
                        snake: gameState.snake,
                        trivia: gameState.trivia,
                        wheel: gameState.wheel
                    },
                    gameSessionStart: gameState.gameSessionStart
                }, userId);
                
                // Notify parent window (index.html) of balance update
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'balanceUpdate',
                        balance: gameState.balance
                    }, '*');
                }
            } catch (error) {
                console.error('Error saving game state:', error);
            }
        }

        // Previous game implementations remain the same, but all attempt checks
        // now use the session-based attempts from gameState

        // Example from memoryGame.checkMatch():
        checkMatch: function() {
            const [card1, card2] = this.flippedCards;

            if (gameState.memory.attempts > 0 && gameState.sessionActive) {
                gameState.memory.attempts--;
                updateGameUI();
                saveGameState();
            }

            // Rest of the function remains the same
            // ...
        }

        // Similar checks should be added to all game functions that use attempts

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize game state
            const accessGranted = await initializeGameState();
            
            if (!accessGranted) return;
            
            // Show main game container
            document.getElementById('mainGameContainer').style.display = 'block';
            
            // Initialize games
            memoryGame.init();
            diceGame.init();
            snakeGame.init();
            triviaGame.init();
            wheelGame.init();
            
            // Update UI with current state
            updateGameUI();
            document.getElementById('balanceDisplay').textContent = gameState.balance.toLocaleString();
            
            // Rest of the initialization code remains the same
            // ...
        });
    </script>
</body>
</html>
